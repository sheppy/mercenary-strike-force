<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        canvas {
            background: #000;
        }
    </style>
</head>
<body>
    <script src="assets/vendor/lodash/dist/lodash.min.js"></script>
    <script>
        var stage = createRenderer(640, 480, document.body);

        var map = {
            width: 40,
            height: 30,
            tileWidth: 16,
            tileHeight: 16,
            data: [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
                [1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            ]
        };

        // Restructure map
        for (var y = 0; y < map.height; y++) {
            for (var x = 0; x < map.width; x++) {
                var o = map.data[y][x];
                map.data[y][x] = {
                    tile: map.data[y][x]
                };
            }
        }


        function createRenderer(width, height, appendTo) {
            var renderer = {};
            renderer.width = width;
            renderer.height = height;
            renderer.canvas = document.createElement("canvas");
            renderer.canvas.width = 640;
            renderer.canvas.height = 640;
            renderer.ctx = renderer.canvas.getContext("2d");

            if (appendTo) {
                appendTo.appendChild(renderer.canvas);
            }

            return renderer;
        }


        function render() {
            stage.ctx.clearRect(0, 0, stage.width, stage.height);
            renderMap();

            var walls = calculateWalls();

            _.forEach(walls, function (wall) {
                renderWall(stage.ctx, wall.x0, wall.y0, wall.x1, wall.y1, "red");
            });
        }


        function isLeftWall(tiles, x, y, wall) {
            wall = wall || {
                x0: x * map.tileWidth,
                y0: y * map.tileHeight,
                x1: x * map.tileWidth,
                y1: 0
            };

            if (tiles[y] && tiles[y][x].tile && (!tiles[y][x - 1] || !tiles[y][x - 1].tile)) {
                tiles[y][x].parsedLeft = true;

                wall.y1 = (y * map.tileHeight) + map.tileHeight;

                var wallCheck = isLeftWall(tiles, x, y + 1, wall);
                if (wallCheck) {
                    wall = wallCheck;
                }

                return wall;
            }

            return false;
        }

        function isRightWall(tiles, x, y, wall) {
            wall = wall || {
                x0: (x * map.tileWidth) + map.tileWidth,
                y0: y * map.tileHeight,
                x1: (x * map.tileWidth) + map.tileWidth,
                y1: 0
            };

            if (tiles[y] && tiles[y][x].tile && (!tiles[y][x + 1] || !tiles[y][x + 1].tile)) {
                tiles[y][x].parsedRight = true;

                wall.y1 = (y * map.tileHeight) + map.tileHeight;

                var wallCheck = isRightWall(tiles, x, y + 1, wall);
                if (wallCheck) {
                    wall = wallCheck;
                }

                return wall;
            }

            return false;
        }

        function isTopWall(tiles, x, y, wall) {
            wall = wall || {
                x0: x * map.tileWidth,
                y0: y * map.tileHeight,
                x1: 0,
                y1: y * map.tileHeight
            };

            if (tiles[y] && tiles[y][x] && tiles[y][x].tile && (!tiles[y - 1] || !tiles[y - 1][x].tile)) {
                tiles[y][x].parsedTop = true;

                wall.x1 = (x * map.tileWidth) + map.tileWidth;

                var wallCheck = isTopWall(tiles, x + 1, y, wall);
                if (wallCheck) {
                    wall = wallCheck;
                }

                return wall;
            }

            return false;
        }

        function isBottomWall(tiles, x, y, wall) {
            wall = wall || {
                x0: x * map.tileWidth,
                y0: (y * map.tileHeight) + map.tileHeight,
                x1: 0,
                y1: (y * map.tileHeight) + map.tileHeight
            };

            if (tiles[y] && tiles[y][x] && tiles[y][x].tile && (!tiles[y + 1] || !tiles[y + 1][x].tile)) {
                tiles[y][x].parsedBottom = true;

                wall.x1 = (x * map.tileWidth) + map.tileWidth;

                var wallCheck = isBottomWall(tiles, x + 1, y, wall);
                if (wallCheck) {
                    wall = wallCheck;
                }

                return wall;
            }

            return false;
        }


        function calculateWalls() {
            var walls = [];
            var wall = null;
            var tiles = _.cloneDeep(map.data);

            for (var y = 0; y < map.height; y++) {
                for (var x = 0; x < map.width; x++) {
                    wall = null;

                    if (!tiles[y][x].parsedLeft) {
                        wall = isLeftWall(tiles, x, y);
                        if (wall) {
                            walls.push(wall);
                        }
                    }

                    if (!tiles[y][x].parsedRight) {
                        wall = isRightWall(tiles, x, y);
                        if (wall) {
                            walls.push(wall);
                        }
                    }

                    if (!tiles[y][x].parsedTop) {
                        wall = isTopWall(tiles, x, y);
                        if (wall) {
                            walls.push(wall);
                        }
                    }

                    if (!tiles[y][x].parsedBottom) {
                        wall = isBottomWall(tiles, x, y);
                        if (wall) {
                            walls.push(wall);
                        }
                    }
                }
            }

            return walls;
        }


        function renderCircle(ctx, x, y, colour) {
            ctx.fillStyle = colour;
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        function renderWall(ctx, x0, y0, x1, y1, colour) {
            ctx.strokeStyle = colour;
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.stroke();

            renderCircle(ctx, x0, y0, colour);
            renderCircle(ctx, x1, y1, colour);
        }


        function renderMap() {
            stage.ctx.strokeStyle = "#eee";
            stage.ctx.fillStyle = "#999";

            for (var y = 0; y < map.height; y++) {
                for (var x = 0; x < map.width; x++) {
                    if (map.data[y][x].tile) {
                        stage.ctx.fillStyle = "#999";
                        stage.ctx.fillRect(x * map.tileWidth, y * map.tileHeight, map.tileWidth, map.tileHeight);
                    } else {
                        stage.ctx.fillStyle = "#ddd";
                        stage.ctx.fillRect(x * map.tileWidth, y * map.tileHeight, map.tileWidth, map.tileHeight);
                        stage.ctx.strokeRect(x * map.tileWidth, y * map.tileHeight, map.tileWidth, map.tileHeight);
                    }
                }
            }
        }

        render();

        stage.canvas.addEventListener("click", function (e) {
//        stage.canvas.addEventListener("mousemove", function (e) {
            light.x = e.x;
            light.y = e.y;
//            console.log(light);
            render();
        });
    </script>
</body>
</html>